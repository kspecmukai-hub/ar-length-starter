<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AR 丈感チェック（カメラ重ね合わせ）</title>
  <style>
    :root {
      --ui-bg: rgba(255,255,255,.88);
      --ui-blur: 10px;
      --shadow: 0 8px 28px rgba(0,0,0,.15);
      --accent: #0ea5e9;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; }
    body {
      font-family: system-ui, -apple-system, "Noto Sans JP", Segoe UI, Roboto, sans-serif;
      background:#000; color:#111;
    }

    /* カメラ映像 */
    #cam {
      position: fixed;
      inset: 0;
      width: 100vw;
      height: 100vh;
      object-fit: cover;
      background: #000;
    }

    /* シルエット */
    #silhouette {
      position: fixed;
      top: 50%;
      left: 50%;
      height: 80vh;
      transform: translate(-50%, -50%);
      pointer-events: none;
      z-index: 5;
      opacity: .95;
    }

    /* ===== QRコードを右下に固定 ===== */
    #qr {
      position: fixed;
      right: 16px;
      bottom: 16px;
      width: 140px;
      height: auto;
      background: #fff;
      padding: 8px;
      border-radius: 10px;
      box-shadow: var(--shadow);
      z-index: 2147483647; /* 最前面 */
    }
    @media (max-width: 640px) {
      #qr { width: 96px; right: 8px; bottom: 8px; }
      #silhouette { height: 72vh; }
    }

    /* 操作UI */
    .overlay {
      position: fixed;
      left: 0; right: 0; bottom: 0;
      display: grid;
      gap: 10px;
      grid-template-columns: 1fr auto auto auto;
      align-items: center;
      padding: 12px 14px;
      background: var(--ui-bg);
      -webkit-backdrop-filter: blur(var(--ui-blur));
      backdrop-filter: blur(var(--ui-blur));
      border-top-left-radius: 14px;
      border-top-right-radius: 14px;
      box-shadow: var(--shadow);
      z-index: 20;
    }
    .row { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .label { font-size: 14px; opacity:.8; }
    .pill {
      display:inline-flex; align-items:center; justify-content:center;
      min-width: 42px; height: 36px; padding: 0 10px;
      border-radius: 999px; border:1px solid #d0d0d0; background:#fff;
      cursor:pointer; font-weight:600;
    }
    .pill input { appearance:none; }
    .pill.active { border-color:#0ea5e9; box-shadow: 0 0 0 3px rgba(14,165,233,.15); }

    input[type="number"] {
      width: 72px; height: 36px;
      border:1px solid #d0d0d0; border-radius: 8px; padding: 0 8px;
      background:#fff; font-weight:600;
    }

    .btn {
      height: 36px; padding: 0 12px; border-radius: 10px;
      border:1px solid #cfcfcf; background:#fff; cursor:pointer;
    }
    .btn:active { transform: translateY(1px); }
    .btn.primary { border-color: var(--accent); color:#fff; background: var(--accent); }

    .slider-wrap {
      grid-column: 1 / -1;
      background:#fff; border:1px solid #e5e5e5; border-radius: 10px; padding: 8px 10px;
    }
    input[type="range"] { width:100%; }

    /* 画面上部のガイドラベル */
    .tip {
      position: fixed; top: 10px; left: 50%;
      transform: translateX(-50%);
      background: var(--ui-bg);
      -webkit-backdrop-filter: blur(var(--ui-blur));
      backdrop-filter: blur(var(--ui-blur));
      border-radius: 999px; padding: 8px 14px; box-shadow: var(--shadow);
      z-index: 30; font-size: 12px;
    }
  </style>
</head>
<body>
  <div class="tip">カメラに正面を向き、肩幅に合わせてスケールを調整してください。</div>

  <!-- カメラ -->
  <video id="cam" autoplay muted playsinline></video>

  <!-- シルエット（初期はMを表示） -->
  <img id="silhouette" alt="silhouette" src="/ar-length-starter/public/silhouette-M.svg" />

  <!-- 操作UI -->
  <div class="overlay">
    <div class="row">
      <span class="label">サイズ：</span>
      <label class="pill" id="pillS"><input type="radio" name="size" value="S">S</label>
      <label class="pill active" id="pillM"><input type="radio" name="size" value="M" checked>M</label>
      <label class="pill" id="pillL"><input type="radio" name="size" value="L">L</label>
      <span class="label" style="margin-left:12px;">身長：</span>
      <input type="number" id="height" value="160" min="120" max="200" step="1"><span class="label">cm</span>
    </div>
    <div class="row" style="justify-content:flex-end; gap:8px;">
      <button class="btn" id="mirrorBtn">左右反転</button>
      <button class="btn" id="lightBtn">ライト</button>
      <button class="btn" id="pauseBtn">一時停止</button>
    </div>
    <div class="slider-wrap">
      <div class="label" style="margin-bottom:6px;">スケール（肩幅に合わせる）：</div>
      <input type="range" id="scaleX" min="0.8" max="1.3" step="0.01" value="1.00">
    </div>
  </div>

  <!-- ✅ QRコード：overlayの外に置く（最前面に出る） -->
  <img id="qr" src="/ar-length-starter/public/qr.png" alt="QR" />

  <script>
    const BASE = '/ar-length-starter/public/';
    const MAP  = { S:'silhouette-S.svg', M:'silhouette-M.svg', L:'silhouette-L.svg' };

    const video = document.getElementById('cam');
    const img   = document.getElementById('silhouette');
    const scale = document.getElementById('scaleX');
    const heightInput = document.getElementById('height');
    const pillS = document.getElementById('pillS');
    const pillM = document.getElementById('pillM');
    const pillL = document.getElementById('pillL');

    (async () => {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }, audio: false });
        video.srcObject = stream;
      } catch (e) {
        alert('カメラの使用許可が必要です：' + e.message);
      }
    })();

    function setSize(size) {
      img.src = BASE + MAP[size];
      [pillS, pillM, pillL].forEach(el => el.classList.remove('active'));
      ({S:pillS, M:pillM, L:pillL}[size]).classList.add('active');
    }
    document.querySelectorAll('input[name="size"]').forEach(r => {
      r.addEventListener('change', () => setSize(r.value));
    });

    function applyScale() {
      const sx = parseFloat(scale.value);
      img.style.transform = `translate(-50%, -50%) scaleX(${sx})`;
    }
    scale.addEventListener('input', applyScale);
    applyScale();

    heightInput.addEventListener('change', () => {
      // 必要ならここで縦サイズ連動ロジックを追加
    });

    let mirrored = false;
    document.getElementById('mirrorBtn').addEventListener('click', () => {
      mirrored = !mirrored;
      video.style.transform = mirrored ? 'scaleX(-1)' : 'none';
    });

    let torchOn = false;
    document.getElementById('lightBtn').addEventListener('click', async () => {
      try {
        const track = video.srcObject?.getVideoTracks?.()[0];
        if (!track) return;
        const capabilities = track.getCapabilities?.();
        if (capabilities && 'torch' in capabilities) {
          torchOn = !torchOn;
          await track.applyConstraints({ advanced: [{ torch: torchOn }] });
        } else {
          alert('ライト未対応の端末です。');
        }
      } catch (e) {
        console.warn(e);
        alert('ライト制御に失敗しました。');
      }
    });

    let paused = false;
    document.getElementById('pauseBtn').addEventListener('click', () => {
      paused = !paused;
      if (paused) { video.pause(); } else { video.play(); }
    });

    setSize('M');
  </script>
</body>
</html>
